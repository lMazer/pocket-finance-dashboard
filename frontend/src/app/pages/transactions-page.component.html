<section class="pf-page">
  <article class="pf-card transactions-panel" [attr.aria-busy]="isLoading() || isSaving() || isImporting() || isExporting()">
    <div class="pf-card__header">
      <div>
        <h2 class="pf-card__title">Transacoes</h2>
        <p class="pf-card__subtitle">Listagem paginada + filtros persistidos na URL + CRUD real + import/export CSV.</p>
      </div>
      <div class="header-actions">
        <button class="pf-btn" type="button" (click)="downloadCsvTemplate()">Modelo CSV</button>
        <button class="pf-btn" type="button" (click)="exportCsv()" [disabled]="isExporting()">
          {{ isExporting() ? 'Exportando...' : 'Exportar CSV' }}
        </button>
        <label class="pf-btn pf-btn--primary header-actions__import" [class.is-disabled]="isImporting()">
          <span>{{ isImporting() ? 'Importando...' : 'Importar CSV' }}</span>
          <input type="file" accept=".csv,text/csv" (change)="importCsv($event)" [disabled]="isImporting()" />
        </label>
      </div>
    </div>

    <form class="filters" [formGroup]="filterForm" (ngSubmit)="applyFilters()">
      <label>
        <span>Mes</span>
        <input type="month" formControlName="month" />
      </label>
      <label>
        <span>Categoria</span>
        <select formControlName="category">
          <option value="">Todas</option>
          @for (category of categories(); track category.id) {
            <option [value]="category.id">{{ category.name }}</option>
          }
        </select>
      </label>
      <label>
        <span>Tipo</span>
        <select formControlName="type">
          <option value="">Todos</option>
          @for (type of transactionTypes; track type.value) {
            <option [value]="type.value">{{ type.label }}</option>
          }
        </select>
      </label>
      <label class="filters__search">
        <span>Busca</span>
        <input type="search" formControlName="q" placeholder="Descricao" />
      </label>
      <div class="filters__actions">
        <button class="pf-btn pf-btn--primary" type="submit">Filtrar</button>
        <button class="pf-btn" type="button" (click)="clearFilters()">Limpar</button>
      </div>
    </form>

    <form class="editor" [formGroup]="transactionForm" (ngSubmit)="submit()">
      <label>
        <span>Categoria</span>
        <select formControlName="categoryId">
          <option value="">Selecione...</option>
          @for (category of categories(); track category.id) {
            <option [value]="category.id">{{ category.name }}</option>
          }
        </select>
      </label>
      <label>
        <span>Tipo</span>
        <select formControlName="type">
          @for (type of transactionTypes; track type.value) {
            <option [value]="type.value">{{ type.label }}</option>
          }
        </select>
      </label>
      <label>
        <span>Descricao</span>
        <input type="text" formControlName="description" placeholder="Ex.: Mercado" />
      </label>
      <label>
        <span>Valor</span>
        <input type="number" formControlName="amount" min="0.01" step="0.01" placeholder="0.00" />
      </label>
      <label>
        <span>Data</span>
        <input type="date" formControlName="date" />
      </label>
      <div class="editor__actions">
        <button class="pf-btn pf-btn--primary" type="submit" [disabled]="isSaving() || !categories().length">
          {{ isSaving() ? 'Salvando...' : editingTransactionId() ? 'Atualizar' : 'Criar transacao' }}
        </button>
        @if (editingTransactionId()) {
          <button class="pf-btn" type="button" (click)="cancelEdit()">Cancelar</button>
        }
      </div>
    </form>

    @if (loadError()) {
      <app-state-error [message]="loadError()!" />
    }

    @if (isLoading()) {
      <app-state-loading message="Carregando transacoes..." />
    } @else if (!(pageData()?.items?.length)) {
      <app-state-empty message="Nenhuma transacao encontrada para os filtros selecionados." />
    } @else {
      <div class="table-wrap">
        <table class="table">
          <caption class="pf-sr-only">
            Tabela de transacoes filtradas com colunas de data, descricao, categoria, tipo, valor e acoes.
          </caption>
          <thead>
            <tr>
              <th scope="col">Data</th>
              <th scope="col">Descricao</th>
              <th scope="col">Categoria</th>
              <th scope="col">Tipo</th>
              <th scope="col" class="table__amount-col">Valor</th>
              <th scope="col" class="table__actions-col">Acoes</th>
            </tr>
          </thead>
          <tbody>
            @for (row of pageData()!.items; track trackByTransactionId($index, row)) {
              <tr>
                <td data-label="Data">{{ row.date | date: 'dd/MM/yyyy' }}</td>
                <td data-label="Descricao">{{ row.description }}</td>
                <td data-label="Categoria">{{ row.categoryName }}</td>
                <td data-label="Tipo">{{ row.type === 'INCOME' ? 'Receita' : 'Despesa' }}</td>
                <td data-label="Valor" [class]="amountClass(row.type)">
                  {{ row.amount | currency: 'BRL' : 'symbol' : '1.2-2' : 'pt-BR' }}
                </td>
                <td data-label="Acoes" class="table__actions">
                  <button class="pf-btn" type="button" (click)="edit(row)">Editar</button>
                  <button
                    class="pf-btn pf-btn--danger"
                    type="button"
                    (click)="delete(row)"
                    [disabled]="isDeletingId() === row.id"
                  >
                    {{ isDeletingId() === row.id ? 'Excluindo...' : 'Excluir' }}
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <div class="pager">
        <p class="pager__meta">
          Pagina {{ pageData()!.page + 1 }} de {{ pageData()!.totalPages || 1 }} Â· {{ pageData()!.totalElements }} itens
        </p>
        <div class="pager__actions">
          <button class="pf-btn" type="button" (click)="previousPage()" [disabled]="pageData()!.page === 0">Anterior</button>
          <button class="pf-btn" type="button" (click)="nextPage()" [disabled]="pageData()!.last">Proxima</button>
        </div>
      </div>
    }
  </article>
</section>
